<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gathurUP Notification Test</title>
    <link rel="icon" href="gathurup.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles_vote.css">
    <style>
        .notification-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
        }

        .status-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-success {
            background-color: var(--green);
        }

        .status-pending {
            background-color: var(--yellow);
        }

        .status-error {
            background-color: var(--red);
        }

        .test-button {
            background: var(--tiffany-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .test-button:hover:not(:disabled) {
            background: var(--header-bg);
            transform: translateY(-1px);
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .error-log {
            color: var(--red);
        }

        .success-log {
            color: var(--green);
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="logo-container">
            <a href="https://gathurup.com/app.html">
                <img src="gathurUP.png" alt="gathurUP Logo">
            </a>
        </div>
        <div class="header-text">
            <h1>Notification Test Page</h1>
            <p>Test push notifications for gathurUP</p>
        </div>
    </div>

    <div class="notification-container">
        <div class="status-card">
            <h2>Notification Status</h2>
            <div id="statusContainer">
                <div class="status-item">
                    <div id="firebaseStatus" class="status-indicator status-pending"></div>
                    <span>Firebase Initialization</span>
                </div>
                <div class="status-item">
                    <div id="swStatus" class="status-indicator status-pending"></div>
                    <span>Service Worker Registration</span>
                </div>
                <div class="status-item">
                    <div id="permissionStatus" class="status-indicator status-pending"></div>
                    <span>Notification Permission</span>
                </div>
                <div class="status-item">
                    <div id="tokenStatus" class="status-indicator status-pending"></div>
                    <span>FCM Token</span>
                </div>
            </div>
        </div>

        <button id="testButton" class="test-button" disabled>
            Send Test Notification
        </button>

        <div id="logContainer" class="log-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-messaging.js";
        import { firebaseConfig } from './firebase-config.js';

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}-log`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Update status indicator
        function updateStatus(id, status) {
            const indicator = document.getElementById(id);
            indicator.className = `status-indicator status-${status}`;
        }

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            updateStatus('firebaseStatus', 'success');
            log('Firebase initialized successfully', 'success');
        } catch (error) {
            updateStatus('firebaseStatus', 'error');
            log('Firebase initialization failed: ' + error.message, 'error');
            return;
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('firebase-messaging-sw.js')
                .then((registration) => {
                    updateStatus('swStatus', 'success');
                    log('Service Worker registered', 'success');
                    initializeMessaging();
                })
                .catch((error) => {
                    updateStatus('swStatus', 'error');
                    log('Service Worker registration failed: ' + error.message, 'error');
                });
        } else {
            updateStatus('swStatus', 'error');
            log('Service Workers not supported', 'error');
        }

        // Initialize messaging
        function initializeMessaging() {
            const messaging = getMessaging();
            
            // Request permission and get token
            Notification.requestPermission()
                .then((permission) => {
                    if (permission === 'granted') {
                        updateStatus('permissionStatus', 'success');
                        log('Notification permission granted', 'success');
                        
                        // Get FCM token
                        getToken(messaging, { 
                            vapidKey: 'RJ1LxE1kQOHwsKIw91wz5RY_lg1GgbpcOAFlMTlcuqY'
                        })
                            .then((token) => {
                                updateStatus('tokenStatus', 'success');
                                log('FCM Token received', 'success');
                                document.getElementById('testButton').disabled = false;
                            })
                            .catch((error) => {
                                updateStatus('tokenStatus', 'error');
                                log('FCM Token failed: ' + error.message, 'error');
                            });
                    } else {
                        updateStatus('permissionStatus', 'error');
                        log('Notification permission denied', 'error');
                    }
                });

            // Handle incoming messages
            onMessage(messaging, (payload) => {
                log('Message received: ' + JSON.stringify(payload), 'success');
            });
        }

        // Test button handler
        document.getElementById('testButton').addEventListener('click', () => {
            log('Sending test notification...');
            // You would typically trigger a cloud function here
            // For testing, we'll just show a native notification
            if ('Notification' in window) {
                new Notification('Test Notification', {
                    body: 'This is a test notification from gathurUP',
                    icon: 'gathurUP.png'
                });
            }
        });
    </script>
</body>
</html>
